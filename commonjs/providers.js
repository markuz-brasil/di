"use strict";

exports.createProviderFromFnOrClass = createProviderFromFnOrClass;
var SuperConstructorAnnotation = require('./annotations').SuperConstructor;
var readAnnotations = require('./annotations').readAnnotations;
var isClass = require('./util').isClass;
var isFunction = require('./util').isFunction;
var isObject = require('./util').isObject;
var toString = require('./util').toString;



// Provider is responsible for creating instances.
//
// responsibilities:
// - create instances
//
// communication:
// - exposes `create()` which creates an instance of something
// - exposes `params` (information about which arguments it requires to be passed into `create()`)
//
// Injector reads `provider.params` first, create these dependencies (however it wants),
// then calls `provider.create(args)`, passing in these arguments.


var EmptyFunction = Object.getPrototypeOf(Function);


// ClassProvider knows how to instantiate classes.
//
// If a class inherits (has parent constructors), this provider normalizes all the dependencies
// into a single flat array first, so that the injector does not need to worry about inheritance.
//
// - all the state is immutable (constructed)
//
// TODO(vojta): super constructor - should be only allowed during the constructor call?
var ClassProvider = (function () {
  var ClassProvider = function ClassProvider(clazz, params, isPromise) {
    // TODO(vojta): can we hide this.provider? (only used for hasAnnotation(provider.provider))
    this.provider = clazz;
    this.isPromise = isPromise;

    this.params = [];
    this._constructors = [];

    this._flattenParams(clazz, params);
    this._constructors.unshift([clazz, 0, this.params.length - 1]);
  };

  ClassProvider.prototype._flattenParams = function (constructor, params) {
    var SuperConstructor;
    var constructorInfo;

    for (var _iterator = params[Symbol.iterator](), _step; !(_step = _iterator.next()).done;) {
      var param = _step.value;
      if (param.token === SuperConstructorAnnotation) {
        SuperConstructor = Object.getPrototypeOf(constructor);

        if (SuperConstructor === EmptyFunction) {
          throw new Error("" + toString(constructor) + " does not have a parent constructor. Only classes with a parent can ask for SuperConstructor!");
        }

        constructorInfo = [SuperConstructor, this.params.length];
        this._constructors.push(constructorInfo);
        this._flattenParams(SuperConstructor, readAnnotations(SuperConstructor).params);
        constructorInfo.push(this.params.length - 1);
      } else {
        this.params.push(param);
      }
    }
  };

  ClassProvider.prototype._createConstructor = function (currentConstructorIdx, context, allArguments) {
    var constructorInfo = this._constructors[currentConstructorIdx];
    var nextConstructorInfo = this._constructors[currentConstructorIdx + 1];
    var argsForCurrentConstructor;

    if (nextConstructorInfo) {
      argsForCurrentConstructor = allArguments.slice(constructorInfo[1], nextConstructorInfo[1]).concat([this._createConstructor(currentConstructorIdx + 1, context, allArguments)]).concat(allArguments.slice(nextConstructorInfo[2] + 1, constructorInfo[2] + 1));
    } else {
      argsForCurrentConstructor = allArguments.slice(constructorInfo[1], constructorInfo[2] + 1);
    }

    return function InjectedAndBoundSuperConstructor() {
      // TODO(vojta): throw if arguments given
      return constructorInfo[0].apply(context, argsForCurrentConstructor);
    };
  };

  ClassProvider.prototype.create = function (args) {
    var context = Object.create(this.provider.prototype);
    var constructor = this._createConstructor(0, context, args);
    var returnedValue = constructor();

    if (isFunction(returnedValue) || isObject(returnedValue)) {
      return returnedValue;
    }

    return context;
  };

  return ClassProvider;
})();




// FactoryProvider knows how to create instance from a factory function.
// - all the state is immutable
var FactoryProvider = (function () {
  var FactoryProvider = function FactoryProvider(factoryFunction, params, isPromise) {
    this.provider = factoryFunction;
    this.params = params;
    this.isPromise = isPromise;

    for (var _iterator2 = params[Symbol.iterator](), _step2; !(_step2 = _iterator2.next()).done;) {
      var param = _step2.value;
      if (param.token === SuperConstructorAnnotation) {
        throw new Error("" + toString(factoryFunction) + " is not a class. Only classes with a parent can ask for SuperConstructor!");
      }
    }
  };

  FactoryProvider.prototype.create = function (args) {
    return this.provider.apply(undefined, args);
  };

  return FactoryProvider;
})();

function createProviderFromFnOrClass(fnOrClass, annotations) {
  if (isClass(fnOrClass)) {
    return new ClassProvider(fnOrClass, annotations.params, annotations.provide.isPromise);
  }

  return new FactoryProvider(fnOrClass, annotations.params, annotations.provide.isPromise);
}
//# sourceMappingURL=data:application/json;base64,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WjtBQUNFLDZCQUFtQixRQUFRLENBQUMsZUFBZSxDQUFDLCtFQUE0RSxDQUFDOzs7OztBQVIzSCxpQkFBZSxXQWFuQixNQUFNLEdBQUEsVUFBQyxJQUFJLEVBQUU7QUFDWDs7O1NBZEUsZUFBZTs7O0FBbUJkLFNBQVMsMkJBQTJCLENBQUMsU0FBUyxFQUFFLFdBQVcsRUFBRTtBQUNsRSxNQUFJLE9BQU8sQ0FBQyxTQUFTLENBQUMsRUFBRTtBQUN0QixXQUFPLElBQUksYUFBYSxDQUFDLFNBQVMsRUFBRSxXQUFXLENBQUMsTUFBTSxFQUFFLFdBQVcsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7R0FDeEY7O0FBRUQsU0FBTyxJQUFJLGVBQWUsQ0FBQyxTQUFTLEVBQUUsV0FBVyxDQUFDLE1BQU0sRUFBRSxXQUFXLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0NBQzFGIiwiZmlsZSI6InByb3ZpZGVycy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7U3VwZXJDb25zdHJ1Y3RvciBhcyBTdXBlckNvbnN0cnVjdG9yQW5ub3RhdGlvbiwgcmVhZEFubm90YXRpb25zfSBmcm9tICcuL2Fubm90YXRpb25zJztcbmltcG9ydCB7aXNDbGFzcywgaXNGdW5jdGlvbiwgaXNPYmplY3QsIHRvU3RyaW5nfSBmcm9tICcuL3V0aWwnO1xuXG5cbi8vIFByb3ZpZGVyIGlzIHJlc3BvbnNpYmxlIGZvciBjcmVhdGluZyBpbnN0YW5jZXMuXG4vL1xuLy8gcmVzcG9uc2liaWxpdGllczpcbi8vIC0gY3JlYXRlIGluc3RhbmNlc1xuLy9cbi8vIGNvbW11bmljYXRpb246XG4vLyAtIGV4cG9zZXMgYGNyZWF0ZSgpYCB3aGljaCBjcmVhdGVzIGFuIGluc3RhbmNlIG9mIHNvbWV0aGluZ1xuLy8gLSBleHBvc2VzIGBwYXJhbXNgIChpbmZvcm1hdGlvbiBhYm91dCB3aGljaCBhcmd1bWVudHMgaXQgcmVxdWlyZXMgdG8gYmUgcGFzc2VkIGludG8gYGNyZWF0ZSgpYClcbi8vXG4vLyBJbmplY3RvciByZWFkcyBgcHJvdmlkZXIucGFyYW1zYCBmaXJzdCwgY3JlYXRlIHRoZXNlIGRlcGVuZGVuY2llcyAoaG93ZXZlciBpdCB3YW50cyksXG4vLyB0aGVuIGNhbGxzIGBwcm92aWRlci5jcmVhdGUoYXJncylgLCBwYXNzaW5nIGluIHRoZXNlIGFyZ3VtZW50cy5cblxuXG52YXIgRW1wdHlGdW5jdGlvbiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihGdW5jdGlvbik7XG5cblxuLy8gQ2xhc3NQcm92aWRlciBrbm93cyBob3cgdG8gaW5zdGFudGlhdGUgY2xhc3Nlcy5cbi8vXG4vLyBJZiBhIGNsYXNzIGluaGVyaXRzIChoYXMgcGFyZW50IGNvbnN0cnVjdG9ycyksIHRoaXMgcHJvdmlkZXIgbm9ybWFsaXplcyBhbGwgdGhlIGRlcGVuZGVuY2llc1xuLy8gaW50byBhIHNpbmdsZSBmbGF0IGFycmF5IGZpcnN0LCBzbyB0aGF0IHRoZSBpbmplY3RvciBkb2VzIG5vdCBuZWVkIHRvIHdvcnJ5IGFib3V0IGluaGVyaXRhbmNlLlxuLy9cbi8vIC0gYWxsIHRoZSBzdGF0ZSBpcyBpbW11dGFibGUgKGNvbnN0cnVjdGVkKVxuLy9cbi8vIFRPRE8odm9qdGEpOiBzdXBlciBjb25zdHJ1Y3RvciAtIHNob3VsZCBiZSBvbmx5IGFsbG93ZWQgZHVyaW5nIHRoZSBjb25zdHJ1Y3RvciBjYWxsP1xuY2xhc3MgQ2xhc3NQcm92aWRlciB7XG4gIGNvbnN0cnVjdG9yKGNsYXp6LCBwYXJhbXMsIGlzUHJvbWlzZSkge1xuICAgIC8vIFRPRE8odm9qdGEpOiBjYW4gd2UgaGlkZSB0aGlzLnByb3ZpZGVyPyAob25seSB1c2VkIGZvciBoYXNBbm5vdGF0aW9uKHByb3ZpZGVyLnByb3ZpZGVyKSlcbiAgICB0aGlzLnByb3ZpZGVyID0gY2xheno7XG4gICAgdGhpcy5pc1Byb21pc2UgPSBpc1Byb21pc2U7XG5cbiAgICB0aGlzLnBhcmFtcyA9IFtdO1xuICAgIHRoaXMuX2NvbnN0cnVjdG9ycyA9IFtdO1xuXG4gICAgdGhpcy5fZmxhdHRlblBhcmFtcyhjbGF6eiwgcGFyYW1zKTtcbiAgICB0aGlzLl9jb25zdHJ1Y3RvcnMudW5zaGlmdChbY2xhenosIDAsIHRoaXMucGFyYW1zLmxlbmd0aCAtIDFdKTtcbiAgfVxuXG4gIC8vIE5vcm1hbGl6ZSBwYXJhbXMgZm9yIGFsbCB0aGUgY29uc3RydWN0b3JzIChpbiB0aGUgY2FzZSBvZiBpbmhlcml0YW5jZSksXG4gIC8vIGludG8gYSBzaW5nbGUgZmxhdCBhcnJheSBvZiBEZXBlbmRlbmN5RGVzY3JpcHRvcnMuXG4gIC8vIFNvIHRoYXQgdGhlIGluamVjdG9yIGRvZXMgbm90IGhhdmUgdG8gd29ycnkgYWJvdXQgaW5oZXJpdGFuY2UuXG4gIC8vXG4gIC8vIFRoaXMgZnVuY3Rpb24gbXV0YXRlcyBgdGhpcy5wYXJhbXNgIGFuZCBgdGhpcy5fY29uc3RydWN0b3JzYCxcbiAgLy8gYnV0IGl0IGlzIG9ubHkgY2FsbGVkIGR1cmluZyB0aGUgY29uc3RydWN0b3IuXG4gIC8vIFRPRE8odm9qdGEpOiByZW1vdmUgdGhlIGFubm90YXRpb25zIGFyZ3VtZW50P1xuICBfZmxhdHRlblBhcmFtcyhjb25zdHJ1Y3RvciwgcGFyYW1zKSB7XG4gICAgdmFyIFN1cGVyQ29uc3RydWN0b3I7XG4gICAgdmFyIGNvbnN0cnVjdG9ySW5mbztcblxuICAgIGZvciAodmFyIHBhcmFtIG9mIHBhcmFtcykge1xuICAgICAgaWYgKHBhcmFtLnRva2VuID09PSBTdXBlckNvbnN0cnVjdG9yQW5ub3RhdGlvbikge1xuICAgICAgICBTdXBlckNvbnN0cnVjdG9yID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKGNvbnN0cnVjdG9yKTtcblxuICAgICAgICBpZiAoU3VwZXJDb25zdHJ1Y3RvciA9PT0gRW1wdHlGdW5jdGlvbikge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgJHt0b1N0cmluZyhjb25zdHJ1Y3Rvcil9IGRvZXMgbm90IGhhdmUgYSBwYXJlbnQgY29uc3RydWN0b3IuIE9ubHkgY2xhc3NlcyB3aXRoIGEgcGFyZW50IGNhbiBhc2sgZm9yIFN1cGVyQ29uc3RydWN0b3IhYCk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdHJ1Y3RvckluZm8gPSBbU3VwZXJDb25zdHJ1Y3RvciwgdGhpcy5wYXJhbXMubGVuZ3RoXTtcbiAgICAgICAgdGhpcy5fY29uc3RydWN0b3JzLnB1c2goY29uc3RydWN0b3JJbmZvKTtcbiAgICAgICAgdGhpcy5fZmxhdHRlblBhcmFtcyhTdXBlckNvbnN0cnVjdG9yLCByZWFkQW5ub3RhdGlvbnMoU3VwZXJDb25zdHJ1Y3RvcikucGFyYW1zKTtcbiAgICAgICAgY29uc3RydWN0b3JJbmZvLnB1c2godGhpcy5wYXJhbXMubGVuZ3RoIC0gMSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnBhcmFtcy5wdXNoKHBhcmFtKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyBCYXNpY2FsbHkgdGhlIHJldmVyc2UgcHJvY2VzcyB0byBgdGhpcy5fZmxhdHRlblBhcmFtc2A6XG4gIC8vIFdlIGdldCBhcmd1bWVudHMgZm9yIGFsbCB0aGUgY29uc3RydWN0b3JzIGFzIGEgc2luZ2xlIGZsYXQgYXJyYXkuXG4gIC8vIFRoaXMgbWV0aG9kIGdlbmVyYXRlcyBwcmUtYm91bmQgXCJzdXBlckNvbnN0cnVjdG9yXCIgd3JhcHBlciB3aXRoIGNvcnJlY3RseSBwYXNzaW5nIGFyZ3VtZW50cy5cbiAgX2NyZWF0ZUNvbnN0cnVjdG9yKGN1cnJlbnRDb25zdHJ1Y3RvcklkeCwgY29udGV4dCwgYWxsQXJndW1lbnRzKSB7XG4gICAgdmFyIGNvbnN0cnVjdG9ySW5mbyA9IHRoaXMuX2NvbnN0cnVjdG9yc1tjdXJyZW50Q29uc3RydWN0b3JJZHhdO1xuICAgIHZhciBuZXh0Q29uc3RydWN0b3JJbmZvID0gdGhpcy5fY29uc3RydWN0b3JzW2N1cnJlbnRDb25zdHJ1Y3RvcklkeCArIDFdO1xuICAgIHZhciBhcmdzRm9yQ3VycmVudENvbnN0cnVjdG9yO1xuXG4gICAgaWYgKG5leHRDb25zdHJ1Y3RvckluZm8pIHtcbiAgICAgIGFyZ3NGb3JDdXJyZW50Q29uc3RydWN0b3IgPSBhbGxBcmd1bWVudHNcbiAgICAgICAgICAuc2xpY2UoY29uc3RydWN0b3JJbmZvWzFdLCBuZXh0Q29uc3RydWN0b3JJbmZvWzFdKVxuICAgICAgICAgIC5jb25jYXQoW3RoaXMuX2NyZWF0ZUNvbnN0cnVjdG9yKGN1cnJlbnRDb25zdHJ1Y3RvcklkeCArIDEsIGNvbnRleHQsIGFsbEFyZ3VtZW50cyldKVxuICAgICAgICAgIC5jb25jYXQoYWxsQXJndW1lbnRzLnNsaWNlKG5leHRDb25zdHJ1Y3RvckluZm9bMl0gKyAxLCBjb25zdHJ1Y3RvckluZm9bMl0gKyAxKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGFyZ3NGb3JDdXJyZW50Q29uc3RydWN0b3IgPSBhbGxBcmd1bWVudHMuc2xpY2UoY29uc3RydWN0b3JJbmZvWzFdLCBjb25zdHJ1Y3RvckluZm9bMl0gKyAxKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZnVuY3Rpb24gSW5qZWN0ZWRBbmRCb3VuZFN1cGVyQ29uc3RydWN0b3IoKSB7XG4gICAgICAvLyBUT0RPKHZvanRhKTogdGhyb3cgaWYgYXJndW1lbnRzIGdpdmVuXG4gICAgICByZXR1cm4gY29uc3RydWN0b3JJbmZvWzBdLmFwcGx5KGNvbnRleHQsIGFyZ3NGb3JDdXJyZW50Q29uc3RydWN0b3IpO1xuICAgIH07XG4gIH1cblxuICAvLyBJdCBpcyBjYWxsZWQgYnkgaW5qZWN0b3IgdG8gY3JlYXRlIGFuIGluc3RhbmNlLlxuICBjcmVhdGUoYXJncykge1xuICAgIHZhciBjb250ZXh0ID0gT2JqZWN0LmNyZWF0ZSh0aGlzLnByb3ZpZGVyLnByb3RvdHlwZSk7XG4gICAgdmFyIGNvbnN0cnVjdG9yID0gdGhpcy5fY3JlYXRlQ29uc3RydWN0b3IoMCwgY29udGV4dCwgYXJncyk7XG4gICAgdmFyIHJldHVybmVkVmFsdWUgPSBjb25zdHJ1Y3RvcigpO1xuXG4gICAgaWYgKGlzRnVuY3Rpb24ocmV0dXJuZWRWYWx1ZSkgfHwgaXNPYmplY3QocmV0dXJuZWRWYWx1ZSkpIHtcbiAgICAgIHJldHVybiByZXR1cm5lZFZhbHVlO1xuICAgIH1cblxuICAgIHJldHVybiBjb250ZXh0O1xuICB9XG59XG5cblxuLy8gRmFjdG9yeVByb3ZpZGVyIGtub3dzIGhvdyB0byBjcmVhdGUgaW5zdGFuY2UgZnJvbSBhIGZhY3RvcnkgZnVuY3Rpb24uXG4vLyAtIGFsbCB0aGUgc3RhdGUgaXMgaW1tdXRhYmxlXG5jbGFzcyBGYWN0b3J5UHJvdmlkZXIge1xuICBjb25zdHJ1Y3RvcihmYWN0b3J5RnVuY3Rpb24sIHBhcmFtcywgaXNQcm9taXNlKSB7XG4gICAgdGhpcy5wcm92aWRlciA9IGZhY3RvcnlGdW5jdGlvbjtcbiAgICB0aGlzLnBhcmFtcyA9IHBhcmFtcztcbiAgICB0aGlzLmlzUHJvbWlzZSA9IGlzUHJvbWlzZTtcblxuICAgIGZvciAodmFyIHBhcmFtIG9mIHBhcmFtcykge1xuICAgICAgaWYgKHBhcmFtLnRva2VuID09PSBTdXBlckNvbnN0cnVjdG9yQW5ub3RhdGlvbikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7dG9TdHJpbmcoZmFjdG9yeUZ1bmN0aW9uKX0gaXMgbm90IGEgY2xhc3MuIE9ubHkgY2xhc3NlcyB3aXRoIGEgcGFyZW50IGNhbiBhc2sgZm9yIFN1cGVyQ29uc3RydWN0b3IhYCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgY3JlYXRlKGFyZ3MpIHtcbiAgICByZXR1cm4gdGhpcy5wcm92aWRlci5hcHBseSh1bmRlZmluZWQsIGFyZ3MpO1xuICB9XG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVByb3ZpZGVyRnJvbUZuT3JDbGFzcyhmbk9yQ2xhc3MsIGFubm90YXRpb25zKSB7XG4gIGlmIChpc0NsYXNzKGZuT3JDbGFzcykpIHtcbiAgICByZXR1cm4gbmV3IENsYXNzUHJvdmlkZXIoZm5PckNsYXNzLCBhbm5vdGF0aW9ucy5wYXJhbXMsIGFubm90YXRpb25zLnByb3ZpZGUuaXNQcm9taXNlKTtcbiAgfVxuXG4gIHJldHVybiBuZXcgRmFjdG9yeVByb3ZpZGVyKGZuT3JDbGFzcywgYW5ub3RhdGlvbnMucGFyYW1zLCBhbm5vdGF0aW9ucy5wcm92aWRlLmlzUHJvbWlzZSk7XG59XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=